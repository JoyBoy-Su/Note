# 第一章 超标量处理器概览

## 1、为什么需要超标量

程序执行的时间取决于三个参数：`Total Instructions`、`CPI`与`Clock Cycle`。减少程序的执行时间可从三个方向入手：

- 减少指令数：需要对指令的功能进行拓展；
- 减少`CPI`：通过流水线等手段，减少每条指令需要的时钟周期数；但标量处理及的`CPI`瓶颈为1。
- 缩短时钟周期：通过加深流水线等手段，缩短时钟周期；

在标量处理机的基础上，`IPC`始终小于1，即处理机一周期处理的指令存在瓶颈。需要通过超标量的方式，在一个时钟周期中处理 n 条指令（ n > 1），获得更高的`IPC`。但由于设计的复杂性与实现的多样性，需要对性能、功耗等各个方面进行权衡折中（**tradeoff**）。

## 2、流水线基础

流水线通过指令重叠执行的方式，提高了系统整体的吞吐量，提高了cpu器件的利用率。（单个指令的执行时间无法减少，甚至会由于流水寄存器的延迟而提高）。

流水线的各流水段间应相互独立、且耗时均匀。

经典的五级流水线划分：`Fetch、Decode、Execute、Memory`与`Writeback`。

加深流水线，可以提高时钟频率，一定程度上提高执行效率；但级数过多的流水线，会导致流水寄存器的延迟提高，同时器件的端口需求增大功耗提高，分支预测和异常的恢复处理成本也变大，会导致执行效率降低。即“高频低能”。

指令间的相关性：

- 先写后读相关（Read After Write，`RAW`），也称真相关，无法回避；
- 先读后写相关（Write After Read，`WAR`），也称反相关，可以通过寄存器重命名解决；
- 先写后写相关（Write After Write，`WAW`），也称输出相关，可以通过寄存器重命名解决；

以上三种相关，在经典五级流水中，由于指令都是顺序执行，读写寄存器数据一定是按顺序的，因此不存在WAR和WAW相关。

存储器间也会存在同样的相关，但由于无论是 load / store，访存都在`memory`阶段且顺序执行（经典五极流水），不存在访存间的相关。

## 3、超标量流水线

超标量处理器的流水线相较于单发射顺序执行，有更多的控制逻辑，需要检查指令间的相关性等，流水线更加复杂。

分为以下流水级，九级流水，乱序执行顺序提交：

1. Fetch（取指）：完成指令的取出与分支预测；
2. Decode（译码）：对取出的多条指令译码，得到操作数寻址与控制逻辑；
3. Register Renaming（寄存器重命名）：检查相关性，对寄存器操作数进行重命名，完成从`ARF`到`PRF`的映射；
4. Dispatch（分发）：将重命名后的指令写入发射队列（Issue Queue，IQ）和重排缓冲区（Reorder Buffer，ROB）；
5. Issue（发射）：将满足运行条件的指令发射到响应的执行部件（Function Unit，FU），乱序发射；
6. Register File Read（读寄存器）：从`PRF`或旁路网络`bypassing network`中读取操作数；
7. Execute（执行）：执行部件执行指令；
8. Write back（写回）：将执行结果写入`PRF`，且通过旁路网络将结果**送到FU的输入端**；
9. Commit（提交）：将ROB中的指令按序提交或撤回，该指令退休，只有当指令前的所有指令都退休后，该指令才能退休。

为了检查指令间的相关性进行调度，需要使用记分牌器件（Score Board），记录指令的执行状态，执行信息。同时，为了避免错误的store指令写入，需要增加写缓存（Store Buffer），只有当指令退休时，才会从写缓存写入内存。

以上所有的流水段设计会在后续章节分别分析。