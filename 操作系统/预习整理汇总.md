# 操作系统

## 一、操作系统基础知识

### 1.1 操作系统的概念

操作系统（Operating System，OS）是协调硬件资源和软件的一个接口层次。

- 负责管理协调硬件、软件等计算机资源的工作
- 为上层的应用程序、用户提供简单易用的服务（主要指接口和环境）
- 操作系统是系统软件，可以直接控制硬件资源而非硬件

### 1.2 操作系统的功能与目标

（1）实现资源的管理

- 处理机管理（cpu的分配）
- 存储器管理（整个存储层次结构与虚存）
- 文件管理（文件系统）
- 设备管理（IO设备）

（2）为用户提供方便的接口服务

包括命令接口，程序接口与GUI用户界面操作。

命令接口包括脱机命令接口与联机命令接口。联机命令接口，即交互式命令接口，输入一条命令执行一条命令（如在`Terminal`等终端输入指令）；脱机命令接口即顺序执行，编写好一系列指令后由操作系统直接执行涉及的所有指令（如`Windows`中的`.bat`格式文件）。

程序接口即具有特定功能的可执行程序，是一组系统调用（如Windows中的`.dll`文件）

（3）对硬件裸机进行功能扩展，扩充机器的功能。

### 1.3 操作系统的四大特征

操作系统的四大特征为：并发、共享、虚拟、异步；并发和共享为两大最基本特征，并二者互为存在条件。

（1）并发

并发是指在同一个时间间隔内，两个或多个事件同时“发生”。这里的发生是指宏观上同时，而微观上交替（可能是以时间片为单位交替）。与之区分的并行：并行是指两个或多个事件，真正意义上的同时发生（例如体系结构优化的指令级、数据级与线程级并行，并行的发生需要多套设备支持）

对于操作系统来说，并发性是指操作系统中同时运行着多个执行程序。**操作系统和程序并发是同时产生的。**

（2）共享

共享是指系统中的资源可供内存中多个**并发**执行的进程共同使用。

- 互斥共享方式：虽然允许多个进程共同使用，但一个时间段内只允许一个进程访问（宏观上不能同时）；
- 同时共享方式：允许一个时间段内多个进程“同时”访问资源（宏观上同时，微观上可能交替）；

（3）虚拟

虚拟是指把一个物理上的实体映射为多个逻辑上的对应物。物理上的实体是真实存在的，而逻辑上是在用户的角度上看的结果。

例如：

- 虚拟内存，物理上的实体是内存，逻辑上的对应物是包括外存在内大小的可用存储。（空分复用技术）
- 虚拟处理器，物理上的单核处理器，在时间上交替可以看作逻辑上的多个处理器线程。（时分复用技术）

（4）异步

异步是指多道程序环境下，允许多个程序**并发**执行，但由于资源有限，进程的执行不是一步到底的，而是走走停停。

### 1.4 操作系统的分类

操作系统按发展顺序，分为以下几种类别：手工操作阶段，批处理阶段，分时操作系统，实时操作系统，网络操作系统，分布式操作系统，个人计算机操作系统。

（1）手工操作阶段

计算机最开始发明的阶段，此阶段是没有操作系统的，程序通过纸带打孔来书写。需要通过纸带机读取和书写纸带的内容。

缺点：用户独占全机，人机速度矛盾导致的资源利用率极低

（2）批处理操作阶段

- 单道批处理系统：引入了**脱机输入/输出技术**（通过磁带），并通过**监督程序（监督程序负责控制某条程序的执行）**控制作业的输入输出（操作系统雏形）

    优点：缓解了人机速度矛盾，一定程度提高了资源利用率

    缺点：内存中只能有一道程序运行（即不支持并发），程序结束之后才能调入下一道程序（程序的输入/输出过程会耗费大量时间），cpu很长时间内是在等待I/O设备就绪。

- 多道批处理系统：在单道批处理系统的基础上改进，计算机会一次调入多道程序进入内存，**多道程序并发执行**（并发执行需要中断机制，同时使用了流水线技术），**操作系统正式诞生，此时的操作系统拥有并发性和共享性**。

    优点：多程序并发执行，吞吐量增大，资源利用率大幅提升

    缺点：用户响应时间长（需要等待多道程序执行完成后才有相应），没有人机交互功能（不能在执行过程中进行控制）。

（3）分时操作系统

计算机会以时间片的形式**轮流为每个用户/作业**提供服务，各个用户可通过终端与计算机进行交互。

优点：解决了多道批处理系统无法交互与响应时间长的问题

缺点：无法对作业进行时间调度，不能优先处理一些紧急任务。

（4）实时操作系统

对于一些紧急的任务会优先分配时间片进行响应，主要特点是**及时性和可靠性**。

- 硬实时操作系统：每个任务必须在严格的规定时间内完成处理（如导弹系统）
- 软实时操作系统：能接受偶尔违反时间规定（如12306）

（5）网络操作系统

伴随着计算机网络诞生，能将网络中各个计算机连接起来，实现数据传送等功能。实现了网络中各种资源的共享与计算机间的通信。

（6）分布式操作系统

主要特点是分布性和并行性，控制一个计算机集群，任何工作都可以**分布**在这些计算机上，由他们并行、协同完成任务处理。

（7）个人计算机操作系统

方便个人使用。

### 1.5 操作系统的运行机制与体系结构

（1）操作系统的运行机制

cpu处理的指令分为特权指令和非特权指令：

- 非特权指令：如加减等运算指令
- 特权指令：如内存清零指令，不能让普通用户使用。

cpu通过处理器状态（状态寄存器记录）确定当前是否允许执行特权指令：

- 用户态（目态）：只能执行非特权指令
- 核心态（管态）：可以执行所有指令（陷入指令除外）

操作系统根据能否执行特权指令，把程序分为两种：

- 应用程序：运行在目态，只能运行非特权指令。
- 内核程序：运行在管态，是系统资源的管理者，既可以执行特权指令，也可以执行非特权指令。

（2）操作系统的内核

操作系统大致分为两个层次：内核与非内核。

**内核层** 是操作系统中最核心最基本的部分，是计算机上配置的底层软件：

- 最核心功能（离硬件最近）：时钟管理、中断处理、原语（设备驱动、cpu切换等）……

> 时钟管理：实现处理器的计时功能，所有的设备运行都需要依赖同步时钟。
>
> 原语：原语是一种特殊的程序，最接近硬件的部分，这种程序的运行具有原子性。

- 其他功能（对一些系统资源进行管理）：进程管理，存储器管理，设备管理等。

**非内核层** 则是在内核的基础上衍生出来的一些功能性较强较方便的内容

如Linux的内核大小为几十兆，而完整版要几百兆，在docker的镜像中可以通过完善Linux内核实现不同版本的Linux环境（如添加一个vim工具等等）

（3）操作系统体系结构

操作系统的体系结构一般分为：大内核和微内核。

- 大内核：把上述内核层的所有部分全部纳入内核

    优点：高性能

    缺点：内核代码庞大，结构混乱难以维护

- 微内核：只包含最核心功能（不包括对一些系统资源的管理）

    优点：内核功能较少，组织结构清晰，方便维护

    缺点：需要频繁地在管态和目态间切换（因为管态只负责最核心的功能，其他对系统资源的管理程序运行在目态），性能低

### 1.6 中断机制

中断的诞生是为了解决同一个时间段内只能有一道程序执行的问题（各程序只能整体上串行）。发生中断就意味着需要**操作系统介入进行管理工作**。

（1）中断机制概念和作用

广义的中断是指在进程执行过程中，通过中断信号是处理器切换为管态，并执行中断处理程序。

中断发生时，cpu会切换为核心态（即管态）进行中断处理（会暂停并保存原程序，中断处理完成后返回）。有了中断才能实现多个程序的并发执行。目态到管态的切换是由中断完成的，并且**中断是唯一的切换方式**，不存在通过直接操作状态寄存器来实现状态切换的情况。

> 一个基本的并发执行会以时间片为单位，每个时间片结束会通过时钟中断使操作系统接管控制权，通过一系列特权指令控制切换为另一个进程执行。

（2）中断分类

广义上的中断根据中断信号的来源分为内中断和外中断：

- 内中断：又称异常（exception）或陷入（trap），中断信号来自处理器内部，是当前执行指令导致的中断；
- 外中断：简称为中断（狭义的中断），中断信号来自处理器外部，与当前执行的执行无关； 

一般在内外中断同时发生时，内中断优先级高于外中断；外中断信号会被保存。

（3）外中断处理过程

处理器在目态下执行程序指令时，每条指令完成后会检查是否有外部中断信号，如果存在则会进行中断处理：

- 保存处理器现场（如状态寄存器、指令pc、处理器权限等）
- 切换为管态
- 切换为中断处理程序（属于操作系统内核，运行在管态）
- 执行完处理程序后，切换回原进程

### 1.7 系统调用

系统调用操作系统提供给应用程序使用的接口，可以理解为一种可供应用程序调用的特殊函数，应用程序可发起系统调用请求来获取操作系统的服务。

在没有系统调用的情况下，应用程序使用操作系统功能时会出现共享资源冲突的问题，为解决该问题引入系统调用。任何进程想要使用共享资源时，都需要向操作系统发起系统调用，操作系统会对所有的调用请求进行协调管理，从而保证系统的**安全性和稳定性**。

即**为功能的实现增加一层受控的接口，并且功能只能由该接口提供，限制了一些非法情况的出现**。

系统调用的一般分类：

- 设备管理：完成设备的 请求 / 释放 / 启动 等功能
- 文件管理：完成文件的 读 / 写 / 创建 / 删除 等功能
- 进程控制：完成进程的 创建 / 撤销 / 阻塞 / 唤醒 等功能
- 进程通信：完成进程间的 消息传递 / 信号传递 等功能
- 内存管理：完成内存的 分配 / 回收 等功能

系统调用设计到的相关处理总是会使用一些特权资源，因此**系统调用后的处理必须要在管态下执行**。

##  二、进程

### 2.1 进程基础知识

（1）进程的概念

在由单道批处理系统向多道批处理系统转化时，需要在内存中的不同位置保存不同进程的程序段和数据段，因此引入进程的概念。操作系统在每个程序开始执行时，会为该程序创建一个进程控制块（Processing Control Block， PCB），其中包含操作系统对该进程进行管理需要的基本信息。

**程序段、数据段、PCB三部分组成了进程实体（也叫进程映像）**。一般来说，将进程实体简称为进程，创建进程就是创建PCB，撤销进程就是撤销PCB。**PCB是进程存在的唯一标识**。

进程是进程实体的运行过程，是系统进行资源分配和调度的独立单位。进程是**动态**的，而进程实体是静态的。

> PCB中包含的信息：
>
> - 进程描述信息：包括进程标识符`PID`（进程的唯一标识），用户标识符`UID`
> - 进程控制和管理信息：包括进程的状态、进程的优先级
> - 资源分配清单：程序段指针，数据段指针，键盘、鼠标
> - 处理机相关信息：各种寄存器的值，一般用来进程切换时保护现场

（2）进程的组织方式

一个系统上会同时运行多个进程，这些进程的信息需要操作系统统一协调维护。操作系统组织进程的方式主要分为两种：

- 链接方式
- 索引方式

链接方式是按状态将PCB分为多个队列，操作系统持有多个队列的指针；

索引方式是按状态创建多个索引表，索引表中的表项是每个该状态PCB的指针，操作系统持有索引表的指针。

（3）进程的特征

进程和程序有非常大的区别，进程具有以下特征：

- 动态性：进程是程序的一个动态执行过程，是动态产生、变化和消亡的
- 并发性：系统中有多个进程实体并发执行
- 独立性：进程是能独立运行，独立获得资源，独立进行调度的基本单位
- 异步性：各进程独立地，按不可知的速度执行，操作系统需要通过同步机制解决异步问题
- 结构性：每个进程会配置一个PCB，进程的组成结构基本一致

### 2.2 进程状态与转化

（1）进程的状态

进程具有三种基本状态：运行态（Running）、就绪态（Ready）与阻塞态（Waiting）

- 运行态：进程占有CPU并在其上运行；若是单核CPU，每个时刻最多有一个进程处于运行态。
- 就绪态：进程已经具备了运行条件，但由于无CPU空闲无法执行；即已经拥有了除处理器外的所有资源，只需要等待处理器空闲（待调度）
- 阻塞态：因某一事件暂时无法运行（如等待设备完成）。

另外两种状态：创建态与销毁态，分别执行进程创建的前置工作与撤销进程时回收工作。

（2）进程的状态转化

进程的状态机图如下：

<img src="img/ProcessStateMachine.png" style="zoom:80%;" />

### 2.3 进程控制

（1）基本概念

进程的控制其实就是控制进程状态的转变。包括创建态 -> 就绪态、就绪态 -> 执行态、执行态 -> 就绪态、执行态 -> 阻塞态、阻塞态 -> 就绪态 以及 执行态 -> 终止态。

- 创建进程：初始化PCB，分配系统资源
- 创建态 -> 就绪态：修改PCB，并调整组织队列（或索引表）
- 就绪态 -> 执行态：修改PCB，调整组织队列，同时还应该恢复执行现场
- 执行态 -> 就绪态（进程切换）：保存运行环境，修改PCB及队列
- 执行态 -> 阻塞态：保存运行环境，修改PCB及队列
- 阻塞态 -> 就绪态：恢复环境，修改PCB及队列；若阻塞是由于资源请求还需要分配资源
- 执行态 -> 终止态：回收进程资源、撤销PCB

由于修改PCB与调整进程组织队列二者应该是一个原子化的操作，因此为避免进程状态与所处队列不符合的情况，进程的控制采用原语来实现（在原语执行代码前后分别进行**关中断和开中断**，即控制全局中断使能）。

（2）进程控制相关原语

通过原语进行进程控制时，无论是什么情况都要做三个方面的处理：

1. 更新PCB中的信息，包括状态修改，保存运行环境同时恢复运行环境；
2. 将PCB修改到合适的队列
3. 分配 / 回收资源

涉及到的原语有：进程的创建、终止、阻塞、唤醒、切换

### 2.4 进程间通信

系统上运行的进程都有自己独立的一块空间，不同进程间不能相互访问。在此基础上的进程间通信有三种方式：共享存储、消息传递与管道通信。（管道通信与消息传递类比理解Spring整合的消息队列MQ）

（1）共享存储

共享存储是操作系统为通信的进程创立一块共享的内存空间，进行通信的进程都由对该空间的访问权限，因此成为共享。但不同进程访问该存储应该时互斥的，即虽然多个进程都具有访问权限，但不能同时访问。互斥通过操作系统的互斥工具实现（如P，V操作）。

共享存储分为：**基于数据结构的共享与基于存储区的共享**。

基于数据结构的共享，是共享空间里只能存放规定格式的数据，效率低，但存在限制较安全。

基于存储区的共享，是共享空间的数据形式和存放位置，都由进程自由控制，相比之下通信更快，是一种高级的通信方式。

（2）消息传递

消息传递是指进程间的通信通过**格式化**的消息中间件（message）为单位实现。消息中间件包括**消息头和消息体**，前者是消息的收发进程信息，后者是通信的数据。（参考微服务消息队列`RabbitMQ`）

- 直接通信方式：发送进程创建好消息格式后，直接挂到接受进程的消息缓冲队列中（缓冲队列的缓冲作用可以实现异步通信，减少阻塞）。
- 间接通信方式：消息要先发送到消息中间实体，再分发到各个接受进程。

（3）管道通信

管道通信是指，操作系统为需要通信的进程开辟一块大小固定的**缓冲区**作为管道（可以是连接读写进程的一个共享文件）。

管道通信采用半双工通信，某一时间段内只能单向传输；若要双向则需要设置两个管道。同时进程对管道的访问应该是互斥的，只有在一个进程释放管道后其他进程才可以访问。

当管道为空时，读进程的读操作被阻塞；当管道满时，写进程的写操作被阻塞。若没有写满则不允许读，若没有读空则不允许写。

管道中的数据，读出一次后会被管道丢弃，其他进程无法再读出。因此**管道的读进程只能有一个**。

### 2.5 线程与多线程模型

（1）线程的概念与作用

进程是一串顺序执行的指令段，进程只能串行地执行，是程序流执行的最小单位。但部分进程需要同时处理不同任务（如QQ的文件传输与视频），需要在进程中执行不同的处理程序，即并非单纯地串行。

线程即是进程中的一串独立的串行代码（轻量级进程），不同线程间的串行代码会被CPU并发的执行处理，实现了进程中不同任务的并行。引入线程后，进程间可以并发执行，进程内也可以并发处理，线程是cpu调度的基本单位。

**进程是资源分配的基本单位，线程是处理器调度的基本单位**。

线程作为处理器调度的基本单位，：

- 实现了同一个进程内不同任务的并发执行，提高了并发度。
- 统一进程内的线程在进行切换时，不需要更改执行环境，减少了并发带来的系统开销

（2）线程的组成与实现

线程包括一个**线程id（`TID`）和一个线程控制块（Thread Control Block，TCB）**，线程几乎不拥有系统资源，内存等系统资源是分配给进程的。

线程分为用户级线程与内核级线程：

- 用户级线程（User-Level Thread，ULT）：由应用程序通过线程库实现，不经过操作系统，线程间的切换由应用程序负责。对操作系统透明，无法被操作系统调度。
- 内核级线程（Kernel-Level Thread，KLT）：内核级线程的管理工作（调度、切换等）由操作系统完成。

操作系统在进行处理器调度时，由于用户级线程对于操作系统是透明的，因此内核级线程是操作系统调度的基本单位。

## 三、处理机调度

